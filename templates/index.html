<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ú—É–∑—ã–∫–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</title>

    <!-- Bootstrap -->
    <link rel="stylesheet" 
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">

    <style>
        body {
            background: #0e0e0e;
            color: white;
            min-height: 100vh;
        }
        .card {
            background: #1c1c1c;
            border: 1px solid #333;
            height: 100%;
        }
        .form-card {
            background: #1c1c1c;
            border: 1px solid #333;
            padding: 25px;
            border-radius: 10px;
        }
        .results-card {
            background: #1c1c1c;
            border: 1px solid #333;
            padding: 25px;
            border-radius: 10px;
            min-height: 500px;
            max-height: 600px;
            overflow-y: auto;
        }
        .comments-card {
            background: #1c1c1c;
            border: 1px solid #333;
            padding: 20px;
            border-radius: 10px;
            margin-top: 30px;
        }
        #output {
            background: transparent;
            color: #e2e2e2;
            white-space: pre-line;
            font-size: 16px;
        }
        #comments {
            background: transparent;
            color: #e2e2e2;
            white-space: pre-line;
            font-size: 16px;
        }
        .form-select {
            background: #2a2a2a;
            border: 1px solid #444;
            color: white;
        }
        .form-select:focus {
            background: #2a2a2a;
            border-color: #ffc107;
            color: white;
        }
        .btn-warning {
            font-weight: bold;
            padding: 12px;
            font-size: 16px;
        }
        .recommendation-item {
            background: #2a2a2a;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 5px;
        }
        .recommendation-item h5 {
            color: #ffc107;
            margin-bottom: 8px;
        }
        .match-percent {
            font-size: 18px;
            font-weight: bold;
            color: #4CAF50;
        }
        .reason-text {
            color: #bbb;
            font-size: 14px;
            margin-top: 5px;
        }
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1c1c1c;
        }
        ::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>

<body>

<div class="container mt-4">

    <h1 class="text-center mb-4" style="font-size:40px; color: #ffc107;">
        üéµ –ú—É–∑—ã–∫–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
    </h1>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç: —Ñ–æ—Ä–º–∞ –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ –¥–≤–µ –∫–æ–ª–æ–Ω–∫–∏ -->
    <div class="row">
        <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –§–æ—Ä–º–∞ -->
        <div class="col-md-5 mb-4">
            <div class="form-card">
                <h3 class="mb-4" style="color: #ffc107;">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>

                <div class="mb-3">
                    <label class="form-label" style="color: white; font-weight: 500;">–ß–µ–º —Ç—ã –∑–∞–Ω–∏–º–∞–µ—à—å—Å—è</label>
                    <select id="activity" class="form-select">
                        <option value="work">–†–∞–±–æ—Ç–∞—é</option>
                        <option value="train">–¢—Ä–µ–Ω–∏—Ä—É—é—Å—å</option>
                        <option value="sleep">–ó–∞—Å—ã–ø–∞—é</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label" style="color: white; font-weight: 500;">–ü–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç—å</label>
                    <select id="popularity" class="form-select">
                        <option value="popular">–ü–æ–ø—É–ª—è—Ä–Ω–æ–µ</option>
                        <option value="unpopular">–ù–µ–ø–æ–ø—É–ª—è—Ä–Ω–æ–µ</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label" style="color: white; font-weight: 500;">–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ</label>
                    <select id="mood" class="form-select">
                        <option value="energetic">–ë–æ–¥—Ä–æ–µ</option>
                        <option value="calm">–°–ø–æ–∫–æ–π–Ω–æ–µ</option>
                    </select>
                </div>

                <div class="mb-4">
                    <label class="form-label" style="color: white; font-weight: 500;">–Ø–∑—ã–∫</label>
                    <select id="language" class="form-select">
                        <option value="russian">–†—É—Å—Å–∫–æ–µ</option>
                        <option value="foreign">–ò–Ω–æ—Å—Ç—Ä–∞–Ω–Ω–æ–µ</option>
                    </select>
                </div>

                <button onclick="runClips()" class="btn btn-warning w-100">
                    üéØ –ü–æ–ª—É—á–∏—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
                </button>
            </div>
        </div>

        <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ -->
        <div class="col-md-7 mb-4">
            <div class="results-card">
                <h3 class="mb-4" style="color: #ffc107;">–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</h3>
                <div id="output">
                    <p class="text-center mt-5" style="color: white;">–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏ –Ω–∞–∂–º–∏—Ç–µ "–ü–æ–ª—É—á–∏—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏"</p>
                </div>
            </div>
        </div>
    </div>

    <!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –≤–Ω–∏–∑—É –Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É -->
    <div class="row">
        <div class="col-12">
            <div class="comments-card">
                <h3 class="mb-3" style="color: #ffc107;">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h3>
                <div id="comments">
                    <p style="color: white;">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –ø–æ—è–≤—è—Ç—Å—è –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π</p>
                </div>
            </div>
        </div>
    </div>

    <!-- –¶–µ–ø–æ—á–∫–∞ –ø—Ä–∞–≤–∏–ª –≤–Ω–∏–∑—É –Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É -->
    <div class="row">
        <div class="col-12">
            <div class="comments-card" style="margin-top: 20px;">
                <h3 class="mb-3" style="color: #ffc107;">‚öôÔ∏è –¶–µ–ø–æ—á–∫–∞ –ø—Ä–∞–≤–∏–ª</h3>
                <div id="rules-chain" style="max-height: 300px; overflow-y: auto;">
                    <p style="color: white;">–¶–µ–ø–æ—á–∫–∞ –ø—Ä–∞–≤–∏–ª –ø–æ—è–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π</p>
                </div>
            </div>
        </div>
    </div>

</div>


<script>

// –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
function formatRecommendations(text) {
    if (!text || !text.includes("–ú—É–∑—ã–∫–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏")) {
        return "<p class='text-muted text-center mt-5'>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>";
    }

    let html = "";
    // –ò—â–µ–º —Å—Ç—Ä–æ–∫–∏ —Å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏ (—Ñ–æ—Ä–º–∞—Ç: "1. –ù–∞–∑–≤–∞–Ω–∏–µ - –ê—Ä—Ç–∏—Å—Ç (XX% —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ)")
    let recs = text.match(/\d+\. .*? \(.*?% —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ\)/g);
    
    if (recs && recs.length > 0) {
        recs.forEach((r, index) => {
            // –ò–∑–≤–ª–µ–∫–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ, –∞—Ä—Ç–∏—Å—Ç–∞ –∏ –ø—Ä–æ—Ü–µ–Ω—Ç
            let match = r.match(/(\d+)\. (.+?) - (.+?) \((\d+)% —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ\)/);
            if (match) {
                let num = match[1];
                let trackName = match[2];
                let artist = match[3];
                let percent = match[4];
                
                // –ò—â–µ–º –ø—Ä–∏—á–∏–Ω—É
                let reasonText = "";
                let reasonMatch = text.substring(text.indexOf(r) + r.length).match(/   –ü—Ä–∏—á–∏–Ω–∞: (.+)/);
                if (reasonMatch) {
                    reasonText = reasonMatch[1];
                }
                
                html += `
                    <div class="recommendation-item">
                        <h5>${num}. ${trackName} - ${artist}</h5>
                        <div class="match-percent">${percent}% —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ</div>
                        <div class="reason-text">${reasonText}</div>
                    </div>
                `;
            }
        });
    } else {
        html = "<p class='text-muted text-center mt-5'>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>";
    }
    
    return html;
}

// –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
function formatComments(text) {
    if (!text || !text.includes("–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏")) {
        return "<p style='color: white;'>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç</p>";
    }

    let html = "";
    let commentsSection = text.split("–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏")[1];
    // –ë–µ—Ä–µ–º —Ç–æ–ª—å–∫–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏, –¥–æ —Ä–∞–∑–¥–µ–ª–∞ "–¶–µ–ø–æ—á–∫–∞ –ø—Ä–∞–≤–∏–ª"
    if (commentsSection.includes("–¶–µ–ø–æ—á–∫–∞ –ø—Ä–∞–≤–∏–ª")) {
        commentsSection = commentsSection.split("–¶–µ–ø–æ—á–∫–∞ –ø—Ä–∞–≤–∏–ª")[0];
    }
    
    let cMatches = commentsSection.match(/\* .*/g);
    if (cMatches && cMatches.length > 0) {
        cMatches.forEach(c => {
            let commentText = c.replace(/^\* /, "");
            html += `<p style="margin-bottom: 10px; color: white;">‚Ä¢ ${commentText}</p>`;
        });
    } else {
        html = "<p style='color: white;'>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç</p>";
    }
    
    return html;
}

// –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ü–µ–ø–æ—á–∫–∏ –ø—Ä–∞–≤–∏–ª
function formatRulesChain(text) {
    if (!text || !text.includes("–¶–µ–ø–æ—á–∫–∞ –ø—Ä–∞–≤–∏–ª")) {
        return "<p style='color: white;'>–¶–µ–ø–æ—á–∫–∞ –ø—Ä–∞–≤–∏–ª –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç</p>";
    }

    let html = "";
    let rulesSection = text.split("–¶–µ–ø–æ—á–∫–∞ –ø—Ä–∞–≤–∏–ª")[1];
    
    let lMatches = rulesSection.match(/\* .*/g);
    if (lMatches && lMatches.length > 0) {
        lMatches.forEach(l => {
            let ruleText = l.replace(/^\* /, "");
            // –†–∞–∑–¥–µ–ª—è–µ–º –ø—Ä–∞–≤–∏–ª–æ –∏ —Ç–µ–∫—Å—Ç
            let parts = ruleText.split(" : ");
            if (parts.length === 2) {
                html += `<p style="margin-bottom: 8px; color: white;"><strong style="color: #ffc107;">${parts[0]}</strong> : ${parts[1]}</p>`;
            } else {
                html += `<p style="margin-bottom: 8px; color: white;">${ruleText}</p>`;
            }
        });
    } else {
        html = "<p style='color: white;'>–¶–µ–ø–æ—á–∫–∞ –ø—Ä–∞–≤–∏–ª –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç</p>";
    }
    
    return html;
}

// –ó–∞–ø—É—Å–∫ —Å–∏—Å—Ç–µ–º—ã —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
function runClips() {
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
    document.getElementById("output").innerHTML =
        "<div class='text-center mt-5'><span style='color:#00ff00'>‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...</span></div>";
    document.getElementById("comments").innerHTML =
        "<p style='color: white;'>–û–±—Ä–∞–±–æ—Ç–∫–∞...</p>";
    document.getElementById("rules-chain").innerHTML =
        "<p style='color: white;'>–û–±—Ä–∞–±–æ—Ç–∫–∞...</p>";

    let data = {
        activity: document.getElementById("activity").value,
        popularity: document.getElementById("popularity").value,
        mood: document.getElementById("mood").value,
        language: document.getElementById("language").value
    };

    fetch("/run", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(data)
    })
        .then(r => r.json())
        .then(d => {
            if (d.output === "–û–®–ò–ë–ö–ê" || 
                d.output === "–û–®–ò–ë–ö–ê PYTHON" || 
                d.output === "–û–®–ò–ë–ö–ê CLIPSIDE") {

                document.getElementById("output").innerHTML =
                    "<div class='alert alert-danger'><strong>–û–®–ò–ë–ö–ê</strong><br>" +
                    d.error + "</div>";

                document.getElementById("comments").innerHTML =
                    "<p style='color: white;'>–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤</p>";
                document.getElementById("rules-chain").innerHTML =
                    "<p style='color: white;'>–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ü–µ–ø–æ—á–∫–∏ –ø—Ä–∞–≤–∏–ª</p>";

                return;
            }

            // –†–∞–∑–¥–µ–ª—è–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∏ —Ü–µ–ø–æ—á–∫—É –ø—Ä–∞–≤–∏–ª
            let text = d.output.replace(/CLIPS>*/g, "").replace(/\r/g, "");
            
            document.getElementById("output").innerHTML = formatRecommendations(text);
            document.getElementById("comments").innerHTML = formatComments(text);
            document.getElementById("rules-chain").innerHTML = formatRulesChain(text);
        })
        .catch(error => {
            document.getElementById("output").innerHTML =
                "<div class='alert alert-danger'><strong>–û–®–ò–ë–ö–ê</strong><br>" +
                error.message + "</div>";
        });
}
</script>

</body>
</html>
